{% extends 'base.html' %}
{% block title %}UPBIT AutoTrading · 전략별 AI 비교분석{% endblock %}
{% block content %}
<div class="container">

  <!-- 분석 범위/실행/이력 -->
  <div class="row mb-4">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-head"><i class="bi bi-funnel"></i> 분석 범위</div>
        <div class="card-body">
          <form class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">기간 선택</label>
              <select class="form-select">
                <option>최근 24시간</option>
                <option>최근 10일</option>
                <option>최근 30일</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">분석 구분</label>
              <select class="form-select">
                <option>전체</option>
                <option>매수 전략</option>
                <option>매도 전략</option>
                <option>고정 매도</option>
              </select>
            </div>
            <div class="col-md-4">
              <button type="button" class="btn btn-ai w-100 btn-analysis" data-api="/api/run-analysis">AI 분석 실행</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="card">
        <div class="card-head"><i class="bi bi-clock-history"></i> 최근 분석/반영 이력</div>
        <div class="card-body">
          <ul class="list-group">
            {% for h in history %}
            <li class="list-group-item small">{{ h.time }} <span class="text-{{ 'success' if h.type=='apply' else 'primary' }}">{{ h.label }}</span></li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 전략별 자동 매수 최적 파라미터 분석 -->
  <div class="card mb-5">
    <div class="card-head">
      <i class="bi bi-arrow-up-circle"></i> <b>전략별 자동 매수 최적 파라미터 분석</b>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover align-middle text-center bg-white">
        <thead class="table-light">
          <tr>
            <th>전략명</th>
            <th>실행 건수</th>
            <th>승률</th>
            <th>수익률</th>
            <th>AI 분석 결과</th>
            <th>AI 승률</th>
            <th>AI 수익률</th>
            <th>지표 상세</th>
            <th>지표 적용</th>
          </tr>
        </thead>
        <tbody>
          {% for r in buy_results %}
          <tr>
            <td>{{ r.name }}</td><td>{{ r.count }}</td><td>{{ r.win }}</td><td>{{ r.pnl }}</td>
            <td>{{ r.ai_result }}</td><td>{{ r.ai_win }}</td><td>{{ r.ai_pnl }}</td>
            <td><button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#modal-{{ r.key }}">보기</button></td>
            <td><button class="btn btn-outline-success btn-sm">적용</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 전략별 자동 매도 파라미터 최적화 분석 (9전략 전부) -->
  <div class="card mb-5">
    <div class="card-head">
      <i class="bi bi-arrow-down-circle"></i> <b>전략별 자동 매도 파라미터 최적화 분석</b>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover align-middle text-center bg-white">
        <thead class="table-light">
          <tr>
            <th>전략명</th>
            <th>실행 건수</th>
            <th>승률</th>
            <th>수익률</th>
            <th>AI 분석 결과</th>
            <th>AI 승률</th>
            <th>AI 수익률</th>
            <th>지표 상세</th>
            <th>지표 적용</th>
          </tr>
        </thead>
        <tbody>
          {% for r in sell_results %}
          <tr>
            <td>{{ r.name }}</td><td>{{ r.count }}</td><td>{{ r.win }}</td><td>{{ r.pnl }}</td>
            <td>{{ r.ai_result }}</td><td>{{ r.ai_win }}</td><td>{{ r.ai_pnl }}</td>
            <td><button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#modal-{{ r.key }}-SELL">보기</button></td>
            <td><button class="btn btn-outline-success btn-sm">적용</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 모든 전략의 매수/매도 상세 모달 (서버에서 전달된 strategies 변수 활용) -->
<!-- Jinja2 반복문으로 모든 모달 자동 출력 -->
{% for s in strategies %}
<div class="modal fade" id="modal-{{s.key}}" tabindex="-1" aria-labelledby="modalLabel-{{s.key}}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title" id="modalLabel-{{s.key}}">{{s.name}} 매수 지표 상세</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body modal-detail">
      <b>진입조건:</b>
      <ul>
        {% for c in s.buy.cond %}<li>{{c}}</li>{% endfor %}
      </ul>
      <b>AI 추천 파라미터:</b>
      <ul>
        {% for c in s.buy.ai %}<li>{{c}}</li>{% endfor %}
      </ul>
    </div>
  </div></div>
</div>
<div class="modal fade" id="modal-{{s.key}}-SELL" tabindex="-1" aria-labelledby="modalLabel-{{s.key}}-SELL" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title" id="modalLabel-{{s.key}}-SELL">{{s.name}} 매도 지표 상세</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body modal-detail">
      <b>청산조건:</b>
      <ul>
        {% for c in s.sell.cond %}<li>{{c}}</li>{% endfor %}
      </ul>
      <b>AI 추천 파라미터:</b>
      <ul>
        {% for c in s.sell.ai %}<li>{{c}}</li>{% endfor %}
      </ul>
    </div>
  </div></div>
</div>
{% endfor %}

{% endblock %}
