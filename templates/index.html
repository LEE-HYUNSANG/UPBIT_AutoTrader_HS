{% extends 'base.html' %}
{% block title %}UPBIT AutoTrading · 메인 대시보드{% endblock %}
{% block content %}

<div id="layout">
  <!-- 좌측 -->
  <div id="left">
    <div class="card shadow-sm mb-4">
      <div class="card-head">
        <i class="bi bi-robot"></i> 봇 상태
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="현재 봇의 자동매매 구동 상태를 표시합니다. 실행중이면 모든 전략이 실시간 동작합니다."></i>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="badge bg-success px-3" id="bot-status">
            {% if running %}실행중{% else %}정지{% endif %}
          </span>
          <button class="btn btn-primary btn-sm w-50" data-api="{{ '/api/stop-bot' if running else '/api/start-bot' }}">
            {% if running %}중지하기{% else %}시작하기{% endif %}
          </button>
        </div>
        <small class="text-muted">업데이트: {{ updated }}</small>
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-head">
        <i class="bi bi-wallet2"></i> 계좌 요약
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="거래소 잔고와 누적 수익률을 한눈에 확인할 수 있습니다."></i>
      </div>
      <div class="card-body">
        <div class="row gy-2">
          <div class="col-6">현금:</div><div class="col-6 text-end fw-semibold">{{ config.get('cash', '0') }} 원</div>
          <div class="col-6">총 자산:</div><div class="col-6 text-end fw-semibold">{{ config.get('total', '0') }} 원</div>
          <div class="col-6">누적 수익률:</div><div class="col-6 text-end text-success fw-semibold">{{ config.get('pnl', 0) }} %</div>
        </div>
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-head">
        <i class="bi bi-filter-square"></i> 모니터링 코인 조건
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="대시보드에 표시할 코인을 가격·시총 기준으로 필터링합니다."></i>
      </div>
      <div class="card-body">
        <label class="form-label">최소 가격(원)</label>
        <input type="number" class="form-control form-control-sm mb-2" name="min_price" value="{{ config.get('min_price', 0) }}">
        <label class="form-label">최대 가격(원)</label>
        <input type="number" class="form-control form-control-sm mb-2" name="max_price" value="{{ config.get('max_price', 0) }}">
        <label class="form-label">시가총액 순위</label>
        <input type="number" class="form-control form-control-sm mb-3" name="rank" value="{{ config.get('rank', 0) }}">
        <button class="btn btn-primary btn-sm w-100 mb-2" data-api="/api/save-settings">저장</button>
        <button class="btn btn-secondary btn-sm w-100" data-api="/save">파일 저장</button>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-head">
        <i class="bi bi-bell"></i> 실시간 알림
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="체결·손절·익절 등 실시간 이벤트 로그를 보여줍니다."></i>
      </div>
      <div id="liveAlerts" class="card-body small live-alerts">
        {% for a in alerts %}
        <div>[{{ a.time }}] {{ a.message }}</div>
        {% endfor %}
      </div>
    </div>
  </div><!-- /left -->

  <div id="drag"></div>

  <!-- 우측 -->
  <div id="right">
    <!-- 보유코인 관리(매도 모니터링) + 손절·익절/추세 그래프 -->
    <div class="card shadow-sm mb-5">
      <div class="card-head">
        <i class="bi bi-cash-coin"></i> 보유코인 관리 (매도 모니터링)
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="현재 보유 중인 코인의 손익 상태와 매도(Exit) 우선순위를 모니터링합니다."></i>
        <i class="ms-2 bi bi-arrow-clockwise reload-btn" role="button" data-refresh="balances"
           data-bs-toggle="tooltip" title="데이터 새로 고침"></i>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered text-center align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th><th>코인</th>
                <th>손절·익절 그래프 <i class="bi bi-info-circle"></i></th>
                <th>추세 손절·익절 <i class="bi bi-info-circle"></i></th>
                <th>Sell 시그널</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="positionBody">
              {% for p in positions %}
              <tr>
                <td>{{ loop.index }}</td><td>{{ p.coin }}</td>
                <td>
                  <div class="bar-graph">
                    <span class="dot stop"></span>
                    <span class="dot entry" data-pos="{{ p.entry }}"></span>
                    <span class="dot take"></span>
                  </div>
                </td>
                <td>
                  <div class="trend-bar">
                    <span class="tick tick1"></span>
                    <span class="tick tick2"></span>
                    <span class="dot trend {{ p.trend_color }}" data-pos="{{ p.trend }}"></span>
                  </div>
                </td>
                <td><span class="badge badge-{{ p.signal }}">{{ p.signal_label }}</span></td>
                <td><button class="btn btn-sm btn-outline-danger" data-api="/api/manual-sell" data-coin="{{ p.coin }}">수동 매도</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- 매수 모니터링 -->
    <div class="card shadow-sm">
      <div class="card-head">
        <i class="bi bi-bullseye"></i> 매수 모니터링
        <i class="bi bi-question-circle ms-auto" data-bs-toggle="tooltip"
           title="추세·변동성·거래량·체결강도·골든크로스·RSI를 조합해 매수 우선순위를 한눈에 보여줍니다."></i>
        <i class="ms-2 bi bi-arrow-clockwise" role="button" data-refresh="signals"
           data-bs-toggle="tooltip" title="데이터 새로 고침"></i>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered text-center mb-0">
          <thead class="table-light"><tr>
            <th>#</th><th>코인</th>
            <th>추세 <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="🔼 상승 · 🔻 하락 · 🔸 중립"></i></th>
            <th>변동성<br>(ATR%) <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="🔵 High · 🟡 Mid · 🔻 Low"></i></th>
            <th>거래량(%) <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="⏫ 폭증 · 🔼 증가 · 🔻 감소"></i></th>
            <th>체결강도 <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="⏫ 강매수 · 🔼 매수우위 · 🔻 매도우위"></i></th>
            <th>GC <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="🔼 골든 · 🔻 데드 · 🔸 없음"></i></th>
            <th>RIS <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="⏫ 극과매도 · 🔼 과매도 · 🔸 중립 · 🔻 과매수"></i></th>
            <th>Buy 시그널 <i class="bi bi-info-circle" data-bs-toggle="tooltip"
                title="강제 매수·관망·회피·데이터대기"></i></th>
            <th>액션</th>
          </tr></thead>
          <tbody id="signalBody">
            {% for s in signals %}
            <tr>
              <td>{{ loop.index }}</td><td>{{ s.coin }}</td>
              <td class="icon-cell">{{ s.trend }}</td>
              <td class="icon-cell">{{ s.volatility }}</td>
              <td class="icon-cell">{{ s.volume }}</td>
              <td class="icon-cell">{{ s.strength }}</td>
              <td class="icon-cell">{{ s.gc }}</td>
              <td class="icon-cell">{{ s.rsi }}</td>
              <td><span class="badge badge-{{ s.signal_class }}">{{ s.signal }}</span></td>
              <td><button class="btn btn-sm btn-outline-success" data-api="/api/manual-buy" data-coin="{{ s.coin }}">수동 매수</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div><!-- /right -->
</div><!-- /layout -->

{% endblock %}